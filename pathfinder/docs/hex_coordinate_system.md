# Кубическая система координат для гексагональных карт

## Введение

Гексагональные сетки широко используются в игровой индустрии и геоинформационных системах благодаря своим уникальным свойствам. В отличие от квадратных сеток, все соседние ячейки в гексагональной сетке находятся на одинаковом расстоянии друг от друга, что делает перемещение более естественным и устраняет проблемы, связанные с диагональным движением.

Основной сложностью при работе с гексагональными картами является выбор подходящей системы координат. В проекте PathFinder используется **кубическая система координат**, которая обеспечивает интуитивно понятное представление и упрощает вычисления расстояний и поиск соседних ячеек.

## Кубическая система координат

В кубической системе координат каждая гексагональная ячейка представлена тремя координатами $(q, r, s)$, которые удовлетворяют условию:

$$q + r + s = 0$$

Эта система координат называется кубической, потому что ее можно представить как проекцию трехмерной кубической решетки на плоскость с сохранением суммы координат равной нулю.

### Координатные оси

В кубической системе координат используются три оси:

- **q-ось**: направлена с северо-запада на юго-восток
- **r-ось**: направлена с севера на юг
- **s-ось**: направлена с северо-востока на юго-запад

![Кубические координаты](../visualization/hex_coordinates.png)

Для удобства хранения и обработки, поскольку координата $s$ может быть вычислена как $s = -q - r$, мы часто используем только координаты $q$ и $r$, а $s$ вычисляем при необходимости. Эта упрощенная версия называется **аксиальной** системой координат.

## Преимущества кубической системы координат

1. **Упрощенное вычисление расстояний**: Расстояние между двумя гексами в кубических координатах вычисляется как:
   ```
   distance((q1, r1, s1), (q2, r2, s2)) = max(abs(q1-q2), abs(r1-r2), abs(s1-s2))
   ```

2. **Простое определение соседей**: В кубической системе координат соседи ячейки $(q, r, s)$ имеют координаты:
   ```
   (q+1, r-1, s), (q+1, r, s-1), (q, r+1, s-1), (q-1, r+1, s), (q-1, r, s+1), (q, r-1, s+1)
   ```

3. **Симметрия**: Система обладает шестиугольной симметрией, что делает ее удобной для представления гексагональных карт.

4. **Единообразие алгоритмов**: Алгоритмы поиска пути, такие как A* и Dijkstra, легко адаптируются для работы с кубическими координатами.

## Реализация в PathFinder

В нашей библиотеке PathFinder класс `HexCoordinate` реализует кубическую систему координат для гексагональных карт:

```python
class HexCoordinate:
    def __init__(self, q, r, s=None):
        self.q = q
        self.r = r
        self.s = -q - r if s is None else s
        
        # Проверка корректности координат
        assert self.q + self.r + self.s == 0, "Сумма координат должна быть равна 0"
    
    def distance(self, other):
        return max(
            abs(self.q - other.q),
            abs(self.r - other.r),
            abs(self.s - other.s)
        )
    
    def neighbors(self):
        directions = [
            (1, -1, 0), (1, 0, -1), (0, 1, -1),
            (-1, 1, 0), (-1, 0, 1), (0, -1, 1)
        ]
        
        return [HexCoordinate(self.q + dq, self.r + dr, self.s + ds) 
                for dq, dr, ds in directions]
```

## Преобразование между системами координат

### От смещенной к кубической

Смещенная система координат (используемая в некоторых реализациях) может быть преобразована в кубическую:

```python
def offset_to_cube(col, row):
    q = col
    r = row - (col + (col & 1)) // 2
    s = -q - r
    return (q, r, s)
```

### От кубической к смещенной

```python
def cube_to_offset(q, r, s):
    col = q
    row = r + (q + (q & 1)) // 2
    return (col, row)
```

## Заключение

Кубическая система координат обеспечивает элегантный и эффективный способ работы с гексагональными картами. Она позволяет легко вычислять расстояния, определять соседей и интегрируется с алгоритмами поиска пути, что делает ее идеальным выбором для проекта PathFinder.

## Ссылки

- [Описание гексагональных сеток от Amit Patel](https://www.redblobgames.com/grids/hexagons/)
- [Hexagonal Grids on Red Blob Games](https://www.redblobgames.com/grids/hexagons/)
- [Документация класса HexCoordinate](../src/hex/hex_coordinate.py) 