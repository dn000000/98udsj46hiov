# Система расовых модификаторов движения

## Введение

В проекте PathFinder реализована система расовых модификаторов движения, которая позволяет моделировать различные способности рас при перемещении по разным типам местности. Эта система добавляет дополнительную глубину и реализм в процесс поиска пути, так как теперь оптимальные маршруты для разных рас могут значительно отличаться даже на одной и той же карте.

## Концепция расовых модификаторов

Каждая раса имеет свой уникальный набор модификаторов, которые определяют, насколько эффективно представители этой расы могут перемещаться по различным типам местности. Модификаторы выражаются в виде числовых коэффициентов:

- **Коэффициент < 1.0**: Преимущество (движение быстрее)
- **Коэффициент = 1.0**: Нейтральное значение (стандартная скорость)
- **Коэффициент > 1.0**: Штраф (движение медленнее)
- **Коэффициент = ∞**: Непроходимая местность

Базовая скорость передвижения по умолчанию равна 1.0, и все модификаторы применяются к этому значению.

## Расы и их особенности

### Человек (Human)

Люди наиболее приспособлены к цивилизованным областям и построенным дорогам, но испытывают трудности в экстремальных условиях.

| Тип местности | Модификатор | Описание |
|---------------|-------------|----------|
| ROAD          | 0.5         | Люди отлично передвигаются по дорогам благодаря развитой инфраструктуре |
| VILLAGE       | 0.7         | В поселениях люди ориентируются быстрее других рас |
| CASTLE        | 0.8         | Крепости и замки - привычная среда для людей |
| GRASS         | 1.0         | Нейтральный модификатор для обычных равнин |
| FOREST        | 1.3         | Люди замедляются в густых лесах |
| MOUNTAIN      | 1.5         | Горы представляют серьезное препятствие для людей |
| SWAMP         | 1.7         | Люди плохо приспособлены к болотистой местности |
| DESERT        | 1.4         | Пустыни без дорог замедляют людей |
| SNOW          | 1.3         | Снежные регионы умеренно сложны для людей |
| CAVE          | 1.5         | Пещеры непривычны для людей |
| LAVA          | ∞           | Лава непроходима для людей |

### Эльф (Elf)

Эльфы прекрасно ориентируются в лесах и на природе, но менее комфортно чувствуют себя в постройках других рас и подземельях.

| Тип местности | Модификатор | Описание |
|---------------|-------------|----------|
| FOREST        | 0.5         | Эльфы непревзойденны в лесах, их родной среде |
| GRASS         | 0.7         | Природные равнины - комфортная среда для эльфов |
| SNOW          | 0.9         | Эльфы хорошо адаптированы к снежным условиям |
| ROAD          | 1.0         | Нейтральный модификатор для дорог |
| SWAMP         | 1.2         | Эльфы испытывают некоторые трудности в болотах |
| DESERT        | 1.4         | Пустыни неблагоприятны для эльфов |
| MOUNTAIN      | 1.3         | Горы представляют умеренные трудности для эльфов |
| VILLAGE       | 1.5         | Поселения других рас некомфортны для эльфов |
| CASTLE        | 1.6         | Замки и крепости - нетипичная среда для эльфов |
| CAVE          | 2.0         | Пещеры и подземелья крайне неприятны для эльфов |
| LAVA          | ∞           | Лава непроходима для эльфов |

### Гном (Dwarf)

Гномы - мастера горных и подземных регионов, но испытывают трудности в водных и заболоченных местностях.

| Тип местности | Модификатор | Описание |
|---------------|-------------|----------|
| MOUNTAIN      | 0.5         | Горы - родная стихия гномов |
| CAVE          | 0.5         | Пещеры и подземелья идеальны для гномов |
| HILLS         | 0.7         | Холмы очень подходят гномам |
| CASTLE        | 0.9         | Гномы хорошо ориентируются в крепостях |
| ROAD          | 1.0         | Нейтральный модификатор для дорог |
| GRASS         | 1.1         | Открытые равнины умеренно неудобны для гномов |
| DESERT        | 1.3         | Пустыни нехарактерны для гномов |
| FOREST        | 1.4         | Густые леса замедляют гномов |
| SNOW          | 1.2         | Снежные регионы умеренно сложны для гномов |
| VILLAGE       | 1.0         | Поселения не вызывают затруднений у гномов |
| SWAMP         | 2.0         | Болота крайне неудобны для гномов |
| WATER         | 1.8         | Водные препятствия сложны для гномов |
| LAVA          | ∞           | Лава непроходима для гномов |

### Орк (Orc)

Орки выносливы и приспособлены к суровым условиям, включая пустыни и горячие регионы, но менее эффективны в снежных и водных областях.

| Тип местности | Модификатор | Описание |
|---------------|-------------|----------|
| DESERT        | 0.7         | Орки отлично адаптированы к пустыням |
| HILLS         | 0.7         | Холмистая местность идеальна для орков |
| MOUNTAIN      | 0.9         | Горы относительно легки для орков |
| GRASS         | 1.0         | Нейтральный модификатор для равнин |
| FOREST        | 1.1         | Леса незначительно замедляют орков |
| ROAD          | 1.2         | Орки не так эффективны на дорогах как люди |
| SWAMP         | 1.0         | Болота не представляют особой сложности для орков |
| SNOW          | 1.5         | Снежные регионы сложны для орков |
| WATER         | 1.7         | Водные препятствия очень сложны для орков |
| VILLAGE       | 1.3         | Поселения других рас замедляют орков |
| CASTLE        | 1.4         | Замки и крепости неудобны для орков |
| CAVE          | 1.1         | Пещеры относительно проходимы для орков |
| LAVA          | 2.5         | Орки могут пересекать лаву, но с большим штрафом |

## Реализация в коде

В проекте PathFinder каждая раса наследуется от абстрактного базового класса `Race`, который определяет общие методы и атрибуты:

```python
class Race(ABC):
    """
    Абстрактный базовый класс для представления расы.
    
    Определяет интерфейс для получения модификаторов движения по различным типам местности.
    """
    
    def __init__(self, name):
        """
        Инициализирует расу с заданным именем.
        
        Args:
            name (str): Название расы.
        """
        self.name = name
        self.terrain_modifiers = self._init_terrain_modifiers()
    
    @abstractmethod
    def _init_terrain_modifiers(self):
        """
        Инициализирует словарь модификаторов для различных типов местности.
        
        Returns:
            dict: Словарь с ключами типа HexTerrainType и значениями-модификаторами.
        """
        pass
    
    def get_movement_cost(self, terrain_type):
        """
        Возвращает модифицированную стоимость передвижения для данного типа местности.
        
        Args:
            terrain_type (HexTerrainType): Тип местности.
            
        Returns:
            float: Модифицированная стоимость передвижения.
        """
        base_cost = 1.0  # Базовая стоимость перемещения
        modifier = self.terrain_modifiers.get(terrain_type, 1.0)
        
        return base_cost * modifier
    
    def can_traverse(self, terrain_type):
        """
        Проверяет, может ли раса передвигаться по данному типу местности.
        
        Args:
            terrain_type (HexTerrainType): Тип местности.
            
        Returns:
            bool: True, если раса может передвигаться по данному типу местности, иначе False.
        """
        if terrain_type == HexTerrainType.WALL:
            return False
            
        modifier = self.terrain_modifiers.get(terrain_type, 1.0)
        return not math.isinf(modifier)
```

Каждая конкретная раса реализует метод `_init_terrain_modifiers()`, в котором определяются специфичные для нее модификаторы:

```python
class Human(Race):
    """
    Класс, представляющий расу Человек.
    
    Люди лучше всего передвигаются по дорогам и в населенных пунктах,
    но испытывают трудности в экстремальных природных условиях.
    """
    
    def __init__(self):
        """Инициализирует расу Человек."""
        super().__init__("Human")
    
    def _init_terrain_modifiers(self):
        """
        Инициализирует словарь модификаторов для различных типов местности.
        
        Returns:
            dict: Словарь с ключами типа HexTerrainType и значениями-модификаторами.
        """
        return {
            HexTerrainType.ROAD: 0.5,      # Люди быстры на дорогах
            HexTerrainType.VILLAGE: 0.7,   # Поселения - привычная среда
            HexTerrainType.CASTLE: 0.8,    # Замки хорошо подходят людям
            HexTerrainType.GRASS: 1.0,     # Нейтрально для равнин
            HexTerrainType.FOREST: 1.3,    # Леса замедляют людей
            HexTerrainType.MOUNTAIN: 1.5,  # Горы затруднительны
            HexTerrainType.SWAMP: 1.7,     # Болота очень сложны
            HexTerrainType.DESERT: 1.4,    # Пустыни неблагоприятны
            HexTerrainType.SNOW: 1.3,      # Снег замедляет
            HexTerrainType.CAVE: 1.5,      # Пещеры непривычны
            HexTerrainType.LAVA: float('inf')  # Лава непроходима
        }
```

## Применение расовых модификаторов в алгоритме A*

При поиске пути с использованием алгоритма A* расовые модификаторы учитываются при расчете стоимости перехода из одной ячейки в другую:

```python
# В алгоритме A*:
for neighbor in current.get_neighbors(hex_map):
    terrain_type = hex_map.get_terrain_type(neighbor)
    
    if not race.can_traverse(terrain_type):
        continue  # Пропускаем непроходимую местность
    
    # Используем расовый модификатор для расчета стоимости
    movement_cost = race.get_movement_cost(terrain_type)
    tentative_g_score = g_score[current] + movement_cost
```

## Визуализация и примеры

Система расовых модификаторов наглядно демонстрирует свою эффективность при сравнении путей, выбранных различными расами на одной и той же карте. Например:

- **Человек** выберет маршрут, пролегающий преимущественно по дорогам и поселениям
- **Эльф** предпочтет двигаться через леса, даже если это увеличит длину пути
- **Гном** будет стремиться к горам и пещерам, избегая воды и болот
- **Орк** может выбрать прямой путь через лаву, избегая снежных регионов

Это создает реалистичную систему, где каждая раса имеет свои уникальные преимущества и предпочтения при выборе маршрута передвижения.

## Расширение системы

Система расовых модификаторов может быть легко расширена следующими способами:

1. **Добавление новых рас**: Можно создать новые классы, наследующиеся от `Race`, с собственными наборами модификаторов.

2. **Новые типы местности**: Добавление новых типов местности в `HexTerrainType` с соответствующими модификаторами для каждой расы.

3. **Динамические модификаторы**: Модификаторы могут меняться в зависимости от времени суток, погоды или других условий.

4. **Специальные способности**: Некоторые расы могут иметь уникальные способности, например, полет над определенными типами местности или подводное дыхание.

## Заключение

Система расовых модификаторов движения добавляет значительную глубину и реализм в процесс поиска пути в проекте PathFinder. Она обеспечивает уникальное поведение для разных рас, отражающее их физические и культурные особенности, что делает поиск пути более интересным и разнообразным.

## Ссылки

- [Реализация базового класса Race](../src/races/race.py)
- [Реализация класса Human](../src/races/human.py)
- [Реализация класса Elf](../src/races/elf.py)
- [Реализация класса Dwarf](../src/races/dwarf.py)
- [Реализация класса Orc](../src/races/orc.py)
- [Алгоритм A* для гексагональных карт](hex_a_star_algorithm.md)
- [Кубическая система координат для гексагональных карт](hex_coordinate_system.md) 